# Portfolio Theory

```{r}
colnamer <- function(data, name) {
    data %>%
        `colnames<-`(name)
}
```

- The Sharpe Ratio is a measure of the return vs the risk ratio of a portfolio. 
- The Capital Asset Pricing Model (CAPM) will be used to calculate market beta for our assets and portfolio 
- The Fama-French Multi-Factor model will be used to explore multiple linear regression

For more, we can look at 

- (Asset Prices: A Theory of Market Equilibrium under Conditions of Risk)[https://www.efalken.com/LowVolClassics/sharpe64.pdf]
- (The Sharpe Ratio)[https://web.stanford.edu/~wfsharpe/art/sr/sr.htm]
- (Common Risk Factors in the Returns on Stocks and Bonds)[https://rady.ucsd.edu/faculty/directory/valkanov/pub/classes/mfe/docs/fama_french_jfe_1993.pdf]

# Sharpe Ratio

The Sharpe Ratio is defined as the mean of the excess monthly portfolio returns above the risk-free rate, divided by the standard deviation of the excess monthly portfolio returns above the risk-free rate. This is the formulation for 1994 as opposed to 1966. 

The Sharpe Ratio measures excess returns per unit of risk, where we take the standard deviation to represent portfolio risk. 

Sharpe Ratio = $\bar{R_p - R_f} / \sigma_{excess}$

## Sharpe Ratio in xts

```{r}
# choose a risk free rate
rfr <- .0003

# get sharpe ratio
(sharpe_xts <- SharpeRatio(portfolio_returns_xts_rebalanced_monthly,
                          Rf = rfr,
                          FUN = "StdDev") %>%
    `colnames<-`("sharpe_xts"))
```

# Sharpe Ratio in the Tidyverse

```{r}
sharpe_tidy <- portfolio_returns_dplyr %>%
    summarise(sharpe = mean(returns - rfr) / sd(returns - rfr))
```

# Sharpe Ratio in Tidyquant

```{r}
sharpe_tq <- portfolio_tq %>%
    tq_performance(Ra = returns,
                   performance_fun = SharpeRatio,
                   Rf = rfr,
                   FUN = "StdDev") %>%
    colnamer("sharpe_tq")
```

Now we can compare our Sharpe ratio to that of the S&P 500 in the same time period 

```{r}
getSymbols("SPY",
           src = "yahoo",
           from = "2012-12-31",
           auto.assign = TRUE,
           warnings = FALSE) %>%
    map(., ~ Ad(get(.x))) %>%
    reduce(merge) %>%
    colnamer("SPY") %>%
    to.monthly(indexAt = "lastof",
               OHLC = FALSE) -> market_returns_xts

market_returns_xts %>%
    tk_tbl(preserve_index = TRUE,
           rename_index = "date") %>%
    mutate(returns = (log(SPY) - log(lag(SPY)))) %>%
    na.omit() %>%
    summarise(ratio = mean(returns - rfr) / sd(returns - rfr)) -> market_sharpe
```

Our portfolio has underperformed the market during the chosen period.

# Visualizing Sharpe Ratio

Before we visualize the actual sharpe ratio, we can get a sense for what proportion of our portfolio returns exceeded the RFR.

```{r}
portfolio_tq %>%
    mutate(ratio = mean(returns - rfr) / sd(returns - rfr),
           returns_below_rfr = if_else(returns < rfr,
                                       returns,
                                       as.numeric(NA)),
           returns_above_rfr = if_else(returns > rfr,
                                       returns,
                                       as.numeric(NA))) %>%
    mutate_if(is.numeric, ~ round(.x, 4)) -> sharpe_returns
```

```{r}
sharpe_returns %>%
    ggplot(aes(x = date)) +
    geom_point(aes(y = returns_below_rfr),
               color = "orange") +
    geom_point(aes(y = returns_above_rfr),
               color = "forestgreen") +
    geom_vline(xintercept = as.numeric(as.Date("2016-11-30")),
               color = "blue",
               lty = 2,
               alpha = 0.2) +
    geom_hline(yintercept = rfr,
               color = "mediumpurple",
               lty = 5,
               alpha = 0.2) +
    annotate(geom = "text",
             x = as.Date("2016-11-30"),
             y = - 0.04,
             label = "Election",
             fontface = "plain",
             angle = 90,
             alpha = 0.5,
             vjust = 1.5) +
    ylab("% Monthly Returns")
```

Next we can build a histogram of the distribution of returns 

```{r}
sharpe_returns %>%
    ggplot(aes(x = returns)) +
    geom_histogram(alpha = 0.45,
                   binwidth = 0.01,
                   fill = "cornflowerblue",
                   color = "black") +
    geom_vline(xintercept = rfr,
               color = "mediumpurple",
               lty = 2,
               alpha = 0.3) +
    annotate(geom = "text",
             x = rfr,
             y = 13,
             label = "rfr",
             fontface = "plain",
             angle = 90,
             alpha = 0.5,
             vjust = 1)
```

We can also view our portfolio's Sharpe Ratio in comparison with other assets.

```{r}
asset_returns_long %>%
    summarize(std_dev = sd(returns),
              sharpe = mean(returns - rfr) / sd(returns - rfr)) %>%
    add_row(asset = "Portfolio",
            std_dev = port_rolling_sd_xts[1],
            sharpe = sharpe_tq$sharpe_tq) %>%
    ggplot(aes(x = std_dev,
               y = sharpe,
               color = asset)) +
    geom_point(size = 2) +
    geom_text(aes(x = sd(portfolio_tq$returns),
                  y = sharpe_tq$sharpe_tq + 0.02,
                  label = "Portfolio")) +
    ylab("Sharpe Ratio") +
    xlab("Standard Deviation") +
    ggtitle("Sharpe Ratio vs Standard Deviation")
```

S&P still beats our portfolio, but it seems to have more _very slightly_ more risk.

These overall numbers might obscure important periods of fluctuation in our data.

# Rolling Sharpe Ratio in xts

```{r}
window <- 24

rollapply(portfolio_returns_xts_rebalanced_monthly,
          window,
          function(x) SharpeRatio(x,
                           Rf = rfr,
                           FUN = "StdDev")) %>%
    na.omit() %>%
    colnamer("xts") -> roll_sharpe_xts
```

# Rolling Sharpe Ratio with the Tidyverse and tibbletime

```{r}
# create rolling function
sharpe_roll_24 <- rollify(
    function(returns) {
        ratio <- mean(returns - rfr) / sd(returns - rfr)
    },
    window = window)

portfolio_returns_dplyr %>%
    as_tbl_time(index = date) %>%
    mutate(sharpe = sharpe_roll_24(returns)) %>%
    na.omit() %>%
    select(-returns) -> roll_sharpe_tidy
```

# Rolling Sharpe Ratio with Tidyquant

```{r}
sharpe_tq_roll <- function(df) {
    SharpeRatio(df,
                Rf = rfr,
                FUN = "StdDev")
}

portfolio_tq %>%
    tq_mutate(select = returns,
              mutate_fun = rollapply,
              width = window,
              align = "right",
              FUN = sharpe_tq_roll,
              col_rename = "tq_sharpe") %>%
    na.omit() -> roll_sharpe_tq
```

# Visualizing the Rolling Sharpe Ratio

```{r}
highchart(type = "stock") %>%
    hc_title(text = "Rolling 24 Month Sharpe") %>%
    hc_add_series(roll_sharpe_xts,
                  name = "Sharpe",
                  color = "mediumpurple") %>%
    hc_navigator(enabled = FALSE) %>%
    hc_scrollbar(enabled = FALSE) %>%
    hc_add_theme(hc_theme_flat()) %>%
    hc_exporting(enabled = TRUE)
```

In ggplot

```{r}
roll_sharpe_xts %>%
    tk_tbl(preserve_index = TRUE,
           rename_index = "date") %>%
    rename(rolling_sharpe = xts) %>%
    ggplot(aes(x = date,
               y = rolling_sharpe)) +
    geom_line(color = "mediumpurple") +
    ggtitle("Rolling 24 Month Sharpe Ratio") +
    labs(y = "Rolling Sharpe Ratio")
```

# Shiny App Sharpe Ratio

```{r}
symbols <- c("SPY", "EFA", "IJS", "EEM", "AGG")

make_input <- function(symbol, index) {
    fluidRow(
        column(6,
               textInput(paste0("stock_", symbol),
                         paste("Stock", index),
                         symbol)),
        column(6,
               numericInput(paste0("wt_", index),
                            "Portfolio %",
                            value = 20,
                            min = 0,
                            max = 100)))
}

stock_inputs <- imap(symbols, ~ make_input(.x, .y))

date_input <- fluidRow(
    column(6,
           dateInput("date",
                     "Starting Date",
                     "2013-01-01",
                     format = "yyyy-mm-dd")),
    column(6,
           numericInput("window",
                        "Window",
                        min = 1,
                        max = 24,
                        value = 6)))

buttons <- fluidRow(
    column(6,
           numericInput(
               "rfr",
               "RFR %",
               min = .01,
               max = 1,
               value = 0.03,
               step = 0.01)),
    column(6,
           actionButton("roll",
                        "Rolling"## ,
                        ## class = "btn btn-primary"
                        )))


ui <- fluidPage(
    theme = shinythemes::shinytheme("simplex"),
    sidebarLayout(
    sidebarPanel(!!!stock_inputs,
                 date_input,
                 buttons,
                 width = 2),
    mainPanel()
))
```

```{r}
server <- function(input, output, session) {
    
}
```

```{r}
shinyApp(ui, server)
```
